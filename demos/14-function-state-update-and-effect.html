<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Hello World</title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const getWorkshops = async (page) => {
                const response = await fetch(
                    `https://workshops-server.herokuapp.com/workshops?_page=${page}`
                );

                if (!response.ok) {
                    throw new Error(response.statusText);
                }

                const data = await response.json();
                return data; // a Promise is returned that resolves only when data is returned
            };

            function WorkshopsList() {
                const [workshops, setWorkshops] = React.useState([]);
                const [error, setError] = React.useState(null);
                const [completed, setCompleted] = React.useState(false);
                const [page, setPage] = React.useState(1);

                // the effect function can return i) undefined (nothing), or ii) a cleanup function
                // async function always return a Promise object
                // Morl of the story: We cannot make the effect function, an async function
                React.useEffect(
                    // effect function
                    () => {
                        // the helper function is a workaround to avoid using "async" on the effect function
                        async function helper() {
                            try {
                                setCompleted(false);
                                const data = await getWorkshops(page);
                                setWorkshops(data);
                            } catch (error) {
                                setError(error);
                            } finally {
                                setCompleted(true);
                            }
                        }

                        helper();

                        // a cleanup function
                        // return () => {

                        // }
                    },
                    [page /*, completed*/] // if completed is included then the effect will keep running as the completed state keeps changing in the effect
                );

                const previous = () => {
                    if (page <= 1) {
                        return;
                    }

                    setPage(page - 1);
                };

                const next = () => {
                    setPage(page + 1);
                };

                // generate an array of React elements (using for / map etc.)
                // const els = [];
                // for( let i = 0; i < workshops.length; i++ ) {
                //     const workshop = workshops[i];
                //     els.push( <li>{workshop.name}</li> );
                // }

                // const els = workshops.map( w => <li>{w.name}</li> )

                // console.log( els );

                return (
                    <div className="container my-5">
                        <h1>{"List of workshops"}</h1>
                        <div>
                            You are viewing page {page}
                            <div className="my-2">
                                <button
                                    className="btn btn-primary btn-sm me-2"
                                    onClick={previous}
                                >
                                    Previous
                                </button>
                                <button
                                    className="btn btn-primary btn-sm"
                                    onClick={next}
                                >
                                    Next
                                </button>
                            </div>
                        </div>
                        {!completed ? (
                            <div>Loading list of workshops</div>
                        ) : null}
                        {completed && !error && (
                            <ol>
                                {/** key should be
                                 * i) unique among items of that array
                                 * ii) be consistent across renders
                                 *
                                 * Therefore array index is a bad choice (ii is violated)
                                 */}
                                {
                                    // workshops.map( ( w, idx ) => <li key={idx}>{w.name}</li> )
                                    workshops.map((w) => (
                                        <li key={w.id}>{w.name}</li>
                                    ))
                                }
                            </ol>
                        )}
                        {completed && error && (
                            <div>Error occured : {error?.message}</div>
                        )}
                    </div>
                );
            }

            const container = document.getElementById("root");
            const root = ReactDOM.createRoot(container);
            root.render(<WorkshopsList />);
        </script>
    </body>
</html>
